<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vision App - Webcam Classifier</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .video-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      background-color: #000;
      border-radius: 0.25rem;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .video-container video,
    .video-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-light d-flex flex-column min-vh-100">

  <div class="container text-center my-5">
    <h1 class="mb-4">ðŸ§  Smart Vision Classifier</h1>

    <div class="card shadow p-4">
      <div class="video-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
      </div>
      
      <div class="mb-3">
        <select id="camera-select" class="form-select">
          <option value="">Select Camera...</option>
        </select>
      </div>

      <button id="capture" class="btn btn-primary mb-3">Capture & Predict</button>

      <div id="result" class="alert alert-secondary d-flex align-items-center justify-content-center" role="alert">
        <div id="spinner" class="spinner-border me-2" role="status" style="display:none;"></div>
        <span id="result-text">Awaiting capture...</span>
      </div>      
    </div>
  </div>

  <footer class="mt-auto text-center p-3">
    <small>&copy; 2025 VisionApp Prototype</small>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = "https://i6dxtr.pythonanywhere.com";

    class VisionApp {
      constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.captureButton = document.getElementById('capture');
        this.resultDiv = document.getElementById('result');
        this.cameraSelect = document.getElementById('camera-select');
        this.availableDevices = [];
        this.currentStream = null;
        
        // Initially hide canvas
        this.canvas.style.display = 'none';
        
        this.setupEventListeners();
        this.initializeCamera();
        this.getCameraDevices();
      }

      async getCameraDevices() {
        try {
          if (!this.currentStream) {
            await this.initializeCamera();
          }
          
          const devices = await navigator.mediaDevices.enumerateDevices();
          this.availableDevices = devices.filter(device => device.kind === 'videoinput');
          
          this.populateCameraSelect();
        } catch (err) {
          console.error('Error enumerating devices:', err);
          this.resultDiv.textContent = 'Error: Could not access camera devices';
        }
      }
      
      populateCameraSelect() {
        this.cameraSelect.innerHTML = '';
        this.cameraSelect.add(new Option('Rear Camera (Default)', 'environment'));
        this.cameraSelect.add(new Option('Front Camera', 'user'));
        
        this.availableDevices.forEach((device, index) => {
          const label = device.label || `Camera ${index + 1}`;
          this.cameraSelect.add(new Option(label, device.deviceId));
        });
      }
      
      async initializeCamera(deviceIdOrMode = 'environment') {
        if (this.currentStream) {
          this.currentStream.getTracks().forEach(track => track.stop());
        }
        
        // Ensure video is visible and canvas is hidden
        this.video.style.display = 'block';
        this.canvas.style.display = 'none';
        
        try {
          const constraints = {
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              ...(typeof deviceIdOrMode === 'string' && 
                  (deviceIdOrMode === 'user' || deviceIdOrMode === 'environment') ? {
                facingMode: { exact: deviceIdOrMode }
              } : {
                deviceId: { exact: deviceIdOrMode }
              })
            }
          };
      
          const stream = await navigator.mediaDevices.getUserMedia(constraints)
            .catch(async (err) => {
              if (deviceIdOrMode === 'user' || deviceIdOrMode === 'environment') {
                return navigator.mediaDevices.getUserMedia({
                  video: { facingMode: deviceIdOrMode }
                });
              }
              throw err;
            });
      
          this.video.srcObject = stream;
          this.currentStream = stream;
          await this.getCameraDevices();
        } catch (err) {
          console.error('Camera error:', err);
          this.resultDiv.textContent = 'Error: Camera access - ' + err.message;
          
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            this.video.srcObject = stream;
            this.currentStream = stream;
            await this.getCameraDevices();
          } catch (fallbackErr) {
            console.error('Fallback camera error:', fallbackErr);
            this.resultDiv.textContent = 'Error: Could not access any camera';
          }
        }
      }

      async captureImage() {
        const displayWidth = this.video.clientWidth;
        const displayHeight = this.video.clientHeight;
        
        this.canvas.width = displayWidth;
        this.canvas.height = displayHeight;
        
        const ctx = this.canvas.getContext('2d');
        ctx.drawImage(this.video, 0, 0, displayWidth, displayHeight);

        this.canvas.style.display = 'block';
        this.video.style.display = 'none';

        const spinner = document.getElementById('spinner');
        const resultText = document.getElementById('result-text');

        this.captureButton.disabled = true;
        spinner.style.display = 'inline-block';
        resultText.textContent = 'Processing...';

        try {
          const blob = await new Promise((resolve) => {
            this.canvas.toBlob(resolve, 'image/jpeg', 0.8);
          });

          const formData = new FormData();
          formData.append('image', blob);

          const response = await fetch(`${API_URL}/predict`, {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          resultText.textContent = `Predicted: ${data.prediction}`;
        } catch (error) {
          console.error('Error:', error);
          resultText.textContent = 'Error: Could not connect to server';
        } finally {
          spinner.style.display = 'none';
          this.captureButton.disabled = false;
          this.canvas.style.display = 'none';
          this.video.style.display = 'block';
        }
      }

      setupEventListeners() {
        this.captureButton.addEventListener('click', () => this.captureImage());
        this.cameraSelect.addEventListener('change', () => {
          this.initializeCamera(this.cameraSelect.value);
        });
      }
    }

    window.addEventListener('load', () => {
      new VisionApp();
    });
  </script>
</body>
</html>